//
//  UIViewController+Request.m
//  商城模板
//
//  Created by 段昌鹤 on 2016/11/14.
//  Copyright © 2016年 jundanuantong. All rights reserved.
//

#import "UIViewController+Request.h"
#import<CommonCrypto/CommonDigest.h>


@implementation UIViewController (Request)

// 修改用户手机号
- (void)changePhoneUserID:(NSString *)user_id
              PhoneNumber:(NSString *)phone
              Sms_captcha:(NSString *)sms_captcha
                    Block:(void (^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:user_id      forKey:@"user_id"];
    [dic setObject:phone        forKey:@"phone"];
    [dic setObject:sms_captcha  forKey:@"sms_captcha"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}












// 获取订单支付 charge
//mer_id=1&opt=Order/GetCharge&order_id=
- (void)getChangeToken:(NSString *)token
                 MerID:(NSString *)mer_id
               OrderID:(NSString *)order_id
                 Block:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"Order/GetCharge"     forKey:@"opt"];
    [dic setObject:mer_id           forKey:@"mer_id"];
    [dic setObject:order_id         forKey:@"order_id"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}


// 订单准备
//currency=cny&goods=[{"id":"","qty":""}]&mer_id=1&opt=Order/Prepare&type=goods
- (void)prepareToken:(NSString *)token
               MerID:(NSString *)mer_id
                Type:(NSString *)type
            Currency:(NSString *)currency
             GoodsID:(NSString *)ID
            GoodsQty:(NSString *)qty
               Block:(void(^)(NSMutableDictionary *))block
{
    NSString *data = [NSString stringWithFormat:@"[{\"id\":%@,\"qty\":%@}]",ID,qty];
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"Order/Prepare"     forKey:@"opt"];
    [dic setObject:mer_id           forKey:@"mer_id"];
    [dic setObject:token         forKey:@"token"];
    [dic setObject:type           forKey:@"type"];
    [dic setObject:currency         forKey:@"currency"];
    [dic setObject:data         forKey:@"data"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}

// 首页
- (void)homeMerID:(NSString *)mer_id
          OrderBy:(NSString *)order_by
            Block:(void(^)(NSMutableDictionary*))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"Page/Home"     forKey:@"opt"];
    [dic setObject:mer_id           forKey:@"mer_id"];
    [dic setObject:order_by         forKey:@"order_by"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}

// 系统区域
//opt=System/Area&pid=0
- (void)areaPid:(NSString *)pid
          Block:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"System/Area"     forKey:@"opt"];
    [dic setObject:pid           forKey:@"pid"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}

#pragma mark -- 上传
// 文件上传 post
//opt=System/FileUpload&path=icon&type=img
- (void)fileUploadFileData:(NSData *)file_data
                      Type:(NSString *)type
                      Path:(NSString *)path
                     Block:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"System/FileUpload"     forKey:@"opt"];
    [dic setObject:file_data                forKey:@"file_data"];
    [dic setObject:type                     forKey:@"type"];
    [dic setObject:path                     forKey:@"path"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}

// 系统信息
//opt=System/Info
- (void)infoBlock:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"System/Info"    forKey:@"opt"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}


// 查询用户收藏
//opt=User/Favorites&type=goods&user_id=
- (void)userFavoritesToken:(NSString *)token
                    UserID:(NSString *)user_id
                      Type:(NSString *)type
                     Block:(void (^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"User/Favorites"    forKey:@"opt"];
    [dic setObject:token                    forKey:@"token"];
    [dic setObject:user_id                     forKey:@"user_id"];
    [dic setObject:type                    forKey:@"type"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}


// 获取足迹
//opt=User/HistoryList&user_id=
- (void)userHistoryListUserID:(NSString *)user_id
                        Block:(void (^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"User/HistoryList"    forKey:@"opt"];
    [dic setObject:user_id                forKey:@"user_id"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}

// 增加足迹
//goods_id=&opt=User/History
- (void)userHistoryUserID:(NSString *)user_id
                  GoodsID:(NSString *)goods_id
                    Block:(void (^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"User/History"      forKey:@"opt"];
    [dic setObject:user_id              forKey:@"user_id"];
    [dic setObject:goods_id             forKey:@"goods_id"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}

// 读取或修改用户信息
//key=icon&opt=User/Info
- (void)UserInfoToken:(NSString *)token
                  Key:(NSString *)key
                Value:(NSString *)value
                Block:(void (^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"User/Info"    forKey:@"opt"];
    [dic setObject:token                    forKey:@"token"];
    [dic setObject:key                     forKey:@"key"];
    [dic setObject:value                    forKey:@"value"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}

// 用户佣金
//opt=User/List&timestamp=1479129078&user_id=
- (void)userListUserID:(NSString *)user_id
                 Block:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"User/List"     forKey:@"opt"];
    [dic setObject:user_id          forKey:@"user_id"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
    
}

// 通过用户随机码获取订单
//opt=User/OrderByCode&ran_code=
- (void)OrderByCodeRanCode:(NSString *)ran_code
                     Block:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"User/OrderByCode"      forKey:@"opt"];
    [dic setObject:ran_code                 forKey:@"ran_code"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}

// 用户订单
//mer_id=1&opt=User/Order&page=1&page_size=6&status=0
- (void)userOrderToken:(NSString *)token
                Status:(NSString *)status
                 MerID:(NSString *)mer_id
                  Page:(NSString *)page
              PageSize:(NSString *)page_size
                 Block:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"User/Order"        forKey:@"opt"];
    [dic setObject:token                forKey:@"token"];
    [dic setObject:status               forKey:@"status"];
    [dic setObject:mer_id               forKey:@"mer_id"];
    [dic setObject:page                 forKey:@"page"];
    [dic setObject:page_size            forKey:@"page_size"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
    
}

// 增加积分
//num=0&opt=User/Point
- (void)userPointUserID:(NSString *)user_id
                 Number:(NSString *)num
                  Block:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"User/Point"            forKey:@"opt"];
    [dic setObject:user_id                  forKey:@"user_id"];
    [dic setObject:num                      forKey:@"num"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}

// 创建用户地址
//address=&area_id=2260&name=&opt=UserAddress/Create&phone=&postcode=
- (void)addressCreateToken:(NSString *)token
                      Name:(NSString *)name
                     Phone:(NSString *)phone
                    AreaID:(NSString *)area_id
                   Address:(NSString *)address
                  Postcode:(NSString *)psotcode
                     Bolck:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"UserAddress/Create"    forKey:@"opt"];
    [dic setObject:token                    forKey:@"token"];
    [dic setObject:name                     forKey:@"name"];
    [dic setObject:phone                    forKey:@"phone"];
    [dic setObject:area_id                  forKey:@"area_id"];
    [dic setObject:address                  forKey:@"address"];
    [dic setObject:psotcode                 forKey:@"psotcode"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}

// 删除用户地址
//id=&opt=UserAddress/Destroy
- (void)addressDestroyToken:(NSString *)token
                  AddressID:(NSString *)ID
                      Bolck:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"UserAddress/Destroy"    forKey:@"opt"];
    [dic setObject:token                     forKey:@"token"];
    [dic setObject:ID                        forKey:@"id"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}

// 获取用户收货地址
//opt=UserAddress/List
- (void)addressListToken:(NSString *)token
                   Block:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"UserAddress/List"    forKey:@"opt"];
    [dic setObject:token                  forKey:@"token"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}

// 修改用户收货地址
//address=&area_id=&id=&is_default=0&name=&opt=UserAddress/Update&phone=&postcode=
- (void)addressUpdateToken:(NSString *)token
                 AddressID:(NSString *)ID
                 IsDefault:(NSString *)is_default
                   address:(NSString *)address
                  Postcode:(NSString *)postcode
                     Block:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"UserAddress/Update"    forKey:@"opt"];
    [dic setObject:ID                       forKey:@"id"];
    [dic setObject:is_default               forKey:@"is_default"];
    [dic setObject:address                  forKey:@"address"];
    [dic setObject:postcode                 forKey:@"postcode"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}


// 清空收货地址
//mer_id=1&opt=UserCart/Destroy
- (void)cartDestroyToken:(NSString *)token
                   MerID:(NSString *)mer_id
                   Block:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"UserCart/Destroy"    forKey:@"opt"];
    [dic setObject:token                  forKey:@"token"];
    [dic setObject:mer_id                 forKey:@"mer_id"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
    
    
}

// 添加到购物车
//goods=[{"id":"","qty":""}]&mer_id=1&opt=UserCart/Insert
- (void)cartInsertToken:(NSString *)token
                  MerID:(NSString *)mer_id
                GoodsID:(NSString *)ID
               GoodsQty:(NSString *)qty
                  Block:(void(^)(NSMutableDictionary *))block
{
    NSString *data = [NSString stringWithFormat:@"[{\"id\":%@,\"qty\":%@}]",ID,qty];
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"UserCart/Insert"     forKey:@"opt"];
    [dic setObject:token                  forKey:@"token"];
    [dic setObject:mer_id                 forKey:@"mer_id"];
    [dic setObject:data                   forKey:@"data"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
    
}

// 获取购物车
//mer_id=1&opt=UserCart/List
- (void)cartListToken:(NSString *)token
                MerID:(NSString *)mer_id
                Block:(void(^)(NSMutableDictionary *))block
{
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"UserCart/List"     forKey:@"opt"];
    [dic setObject:token                forKey:@"token"];
    [dic setObject:mer_id               forKey:@"mer_id"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}

// 更新购物车
//data=[{"id":"","qty":""}]&mer_id=1&opt=UserCart/Update
- (void)cartUpdateToken:(NSString *)token
                  MerID:(NSString *)mer_id
                GoodsID:(NSString *)ID
               GoodsQty:(NSString *)qty
                  Block:(void(^)(NSMutableDictionary *))block
{
    
    NSString *data = [NSString stringWithFormat:@"[{\"id\":%@,\"qty\":%@}]",ID,qty];
    NSMutableDictionary *dic = [NSMutableDictionary dictionary];
    [dic setObject:@"UserCart/Update"     forKey:@"opt"];
    [dic setObject:mer_id                 forKey:@"mer_id"];
    [dic setObject:token                  forKey:@"token"];
    [dic setObject:data                   forKey:@"data"];
    [self getParmar:dic Block:^(NSMutableDictionary *temp) {
        block(temp);
    }];
}








-(void)getParmar:(NSMutableDictionary*)parmar
            Block:(void(^)(NSMutableDictionary*))block;
{
    NSDate *senddate = [NSDate date];
    NSString *date2 = [NSString stringWithFormat:@"%ld", (long)[senddate timeIntervalSince1970]];

    AFHTTPSessionManager *session = [AFHTTPSessionManager manager];
    [session.requestSerializer setValue:@"ios" forHTTPHeaderField:@"client-os"];
    [session.requestSerializer setValue:@"8.0.0" forHTTPHeaderField:@"client-os-ver"];
    [session.requestSerializer setValue:@"1.0.0" forHTTPHeaderField:@"client-ver"];
    [session.requestSerializer setValue:@"V1" forHTTPHeaderField:@"api-ver"];
    [session.requestSerializer setValue:date2 forHTTPHeaderField:@"timestamp"];
    [parmar setObject:date2 forKey:@"timestamp"];
    NSArray *allKeys = [parmar allKeys];
    NSSortDescriptor *descriptor = [[NSSortDescriptor alloc]initWithKey:nil ascending:YES];
    NSArray *sortArray = [NSArray arrayWithObjects:descriptor,nil];
    NSArray *sortedArray = [allKeys sortedArrayUsingDescriptors:sortArray];
    NSString* str = @"";
    for (int i = 0; i < sortedArray.count; i ++) {
        NSString*sf = [sortedArray objectAtIndex:i];
        NSString *sfg = [sortedArray objectAtIndex:i];
        str = [str stringByAppendingString:sfg];
        NSString*sktt = (NSString*)[parmar objectForKey:sf];
        str = [str stringByAppendingString:@"="];
        str = [str stringByAppendingString:sktt];
        str = [str stringByAppendingString:@"&"];
    }
    
    str = [str stringByAppendingString:@"secret=junda_signature_key"];
    NSString *output = [self md5:str];
    [session.requestSerializer setValue:output forHTTPHeaderField:@"signature"];
    [session POST:URI parameters:parmar progress:^(NSProgress * _Nonnull uploadProgress) {
        
    } success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
        NSMutableDictionary * dic = (NSMutableDictionary*) responseObject;
        
        
        if ([dic[@"code"] integerValue]) {
            
            UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"提示"
                                                            message:dic[@"msg"]
                                                           delegate:nil
                                                  cancelButtonTitle:@"取消"
                                                  otherButtonTitles:@"确定", nil];
            [alert show];
            
        }
        
        block(dic);
    } failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
        
        UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"提示"
                                                        message:[NSString stringWithFormat:@"%@",error]
                                                       delegate:nil
                                              cancelButtonTitle:@"取消"
                                              otherButtonTitles:@"确定", nil];
        [alert show];
        
    }];
    
}


- (NSString *) md5:(NSString *) input {
    const char *cStr = [input UTF8String];
    unsigned char digest[CC_MD5_DIGEST_LENGTH];
    CC_MD5( cStr, (int)strlen(cStr), digest );
    
    NSMutableString *output = [NSMutableString stringWithCapacity:CC_MD5_DIGEST_LENGTH * 2];
    
    for(int i = 0; i < CC_MD5_DIGEST_LENGTH; i++)
        [output appendFormat:@"%02x", digest[i]];
    
    return  output;
}





@end
